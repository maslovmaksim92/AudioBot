# üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ:

### –§–∞–∑–∞ 1: –ë–∞–≥–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
- ‚úÖ –ë–∞–≥ –º–µ—Å—è—Ü–∞
- ‚úÖ –ë–∞–≥ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏  
- ‚úÖ –ë–∞–≥ –ö–ü–ò –±—Ä–∏–≥–∞–¥

### –§–∞–∑–∞ 2A: Telegram –±–æ—Ç (–†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
- ‚úÖ `photo_caption_service.py` - AI –ø–æ–¥–ø–∏—Å–∏
- ‚úÖ `telegram_cleaning_bot.py` - –±–æ—Ç –¥–ª—è –±—Ä–∏–≥–∞–¥
- ‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏ callback

### UI —É–ª—É—á—à–µ–Ω–∏—è:
- ‚úÖ –ú–µ–Ω—é –æ—á–∏—â–µ–Ω–æ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ –£–±—Ä–∞–Ω–æ: "–ñ–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä", "–õ–æ–≥–∏—Å—Ç–∏–∫–∞", "AI –ó–∞–¥–∞—á–∏", "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥" –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –º–µ–Ω—é
- ‚úÖ Dashboard –≥—Ä—É–∑–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîÑ –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å:

### 1. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–æ –≤–∫–ª–∞–¥–∫–∏

#### –ê–≥–µ–Ω—Ç—ã (–≥–ª–∞–≤–Ω—ã–π —Ä–∞–∑–¥–µ–ª `/agents`):
–î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫–∏:
- **–ê–≥–µ–Ω—Ç—ã** - —Å–ø–∏—Å–æ–∫/—Å–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ (AgentBuilder)
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - AgentDashboard  
- **AI –ó–∞–¥–∞—á–∏** - AITasks –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- **Telegram –±–æ—Ç** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ –¥–ª—è —Ñ–æ—Ç–æ (–Ω–æ–≤—ã–π)

#### –î–æ–º–∞ (`/works`):
–î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫–∏:
- **–°–ø–∏—Å–æ–∫ –¥–æ–º–æ–≤** - —Ç–µ–∫—É—â–∞—è Works
- **–ö–∞–ª–µ–Ω–¥–∞—Ä—å** - –∫–∞–ª–µ–Ω–¥–∞—Ä—å —É–±–æ—Ä–æ–∫
- **KPI –ë—Ä–∏–≥–∞–¥** - BrigadeStats
- **–õ–æ–≥–∏—Å—Ç–∏–∫–∞** - Logistics –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

#### AI –ß–∞—Ç (`/ai`):
–î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫–∏:
- **–ß–∞—Ç** - —Ç–µ–∫—É—â–∏–π AIChat
- **–ñ–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä** - LiveConversation –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- **–ò—Å—Ç–æ—Ä–∏—è** - –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤

### 2. AI Chat —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–§–∞–∑–∞ 3)

**Backend:**
```sql
CREATE TABLE chat_messages (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    platform VARCHAR(20), -- 'web' or 'telegram'
    content TEXT,
    role VARCHAR(20), -- 'user' or 'assistant'
    created_at TIMESTAMP,
    telegram_message_id BIGINT,
    brain_metadata JSONB
);
```

**–°–æ–∑–¥–∞—Ç—å:**
- `backend/app/services/chat_sync_service.py` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- `backend/app/routers/chat.py` - WebSocket endpoint
- `frontend/src/services/chatWebSocket.js` - WS –∫–ª–∏–µ–Ω—Ç
- –û–±–Ω–æ–≤–∏—Ç—å AIChat.js –¥–ª—è WS

### 3. –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–∏

–î–æ–±–∞–≤–∏—Ç—å –≤ `brain_resolvers.py`:
```python
async def resolve_complaint(text: str, ent: Dict) -> Dict:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π —Ç–∏–ø–∞ "–Ω–µ –±—ã–ª–æ —É–±–æ—Ä–∫–∏ 9 —á–∏—Å–ª–∞"
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ –∏ –≥—Ä–∞—Ñ–∏–∫
    """
    address = extract_address(text)
    date = extract_date(text)
    
    # –ù–∞–π—Ç–∏ —Ñ–æ—Ç–æ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É
    photos = await get_photos_by_address_date(address, date)
    
    return {
        "answer": f"–£–±–æ—Ä–∫–∞ –±—ã–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ {date}",
        "photos": photos,
        "schedule": "..."
    }
```

### 4. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ –ê–≥–µ–Ω—Ç—ã

–í AgentBuilder –¥–æ–±–∞–≤–∏—Ç—å:
- –ù–æ–≤—ã–π action type: "telegram_photo_bot"
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: —Å–ø–∏—Å–æ–∫ –¥–æ–º–æ–≤, –±—Ä–∏–≥–∞–¥–∞
- –¢—Ä–∏–≥–≥–µ—Ä: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

---

## üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ GitHub Push

### –§–∞–π–ª—ã –¥–ª—è –∫–æ–º–º–∏—Ç–∞:

**Backend (–∏–∑–º–µ–Ω–µ–Ω–æ):**
- `app/services/brain_intents.py`
- `app/services/brain_resolvers.py`
- `app/services/bitrix24_service.py`
- `app/routers/telegram_webhook.py`

**Backend (–Ω–æ–≤—ã–µ):**
- `app/services/photo_caption_service.py`
- `app/services/telegram_cleaning_bot.py`

**Frontend (–∏–∑–º–µ–Ω–µ–Ω–æ):**
- `src/components/Works/BrigadeStats.js`
- `src/components/Dashboard/Dashboard.js`
- `src/components/Layout/Layout.js`

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è push:

```bash
cd /app

# –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add backend/app/services/brain_intents.py
git add backend/app/services/brain_resolvers.py
git add backend/app/services/bitrix24_service.py
git add backend/app/services/photo_caption_service.py
git add backend/app/services/telegram_cleaning_bot.py
git add backend/app/routers/telegram_webhook.py
git add frontend/src/components/Works/BrigadeStats.js
git add frontend/src/components/Dashboard/Dashboard.js
git add frontend/src/components/Layout/Layout.js

# –ö–æ–º–º–∏—Ç
git commit -m "
feat: Phase 1 & 2A implementation

Phase 1 - Critical Bugs Fixed:
- Fixed month detection with fallback to current month
- Implemented cleaning type periodicity calculation (3 types)
- Added date selector for Brigade KPI with auto-recalculation

Phase 2A - Telegram Bot for Brigades:
- Created photo_caption_service.py for AI captions via GPT-3.5
- Implemented telegram_cleaning_bot.py with full workflow
- Added /start command with inline keyboard for house selection
- Added photo upload handler and /done command
- Test mode: sends photos back to user (not to group)
- Integrated with telegram_webhook.py

UI Improvements:
- Cleaned up navigation menu (removed duplicates)
- Fixed Dashboard data loading
- Added month selector in Brigade KPI
"

# Push –≤ main
git push origin main
```

---

## üöÄ Deployment –Ω–∞ Render

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:

1. **Environment Variables –Ω–∞ Render:**
```
DATABASE_URL=postgresql://...
OPENAI_API_KEY=sk-...
TELEGRAM_BOT_TOKEN=...
LIVEKIT_URL=...
JWT_SECRET=...
```

2. **Dependencies:**
```bash
# Backend
cat backend/requirements.txt | grep -E "openai|httpx|telegram"

# Frontend  
cat frontend/package.json | grep -E "recharts|reactflow|datepicker"
```

3. **Build Commands:**
- Backend: `pip install -r backend/requirements.txt`
- Frontend: `cd frontend && yarn install && yarn build`

4. **Start Commands:**
- Backend: `uvicorn backend.server:app --host 0.0.0.0 --port 8001`
- Frontend: `cd frontend && yarn start`

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Telegram webhook:**
```bash
curl -X POST https://your-app.onrender.com/api/telegram-webhook/set
```

2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞:**
- –û—Ç–∫—Ä your Telegram –±–æ—Ç
- `/start` - –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–º–æ–≤
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
- `/done` - –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ —Å AI –ø–æ–¥–ø–∏—Å—å—é

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Dashboard:**
- https://your-app.onrender.com
- –î–æ–º–∞ –≥—Ä—É–∑—è—Ç—Å—è
- –ö–ü–ò –±—Ä–∏–≥–∞–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º –º–µ—Å—è—Ü–∞

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞:

‚úÖ –í—Å–µ 3 –±–∞–≥–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã  
‚úÖ Telegram –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ  
‚úÖ Dashboard –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ  
‚úÖ UI –º–µ–Ω—é –æ—á–∏—â–µ–Ω–æ  
‚è≥ AI Chat —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–§–∞–∑–∞ 3)  
‚è≥ –í–∫–ª–∞–¥–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã  
‚è≥ Production –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–ë–î, –≥—Ä—É–ø–ø–∞, Bitrix24)  

---

## üîó –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- `/app/PHASE1_BUGFIX_REPORT.md`
- `/app/PHASE2_TELEGRAM_BOT_REPORT.md`
- `/app/IMPLEMENTATION_PLAN.md`
- `/app/CLEANUP_REPORT.md`
