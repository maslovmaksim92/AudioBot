# 📞 Автоматическая транскрипция звонков Novofon

## 🎯 Описание

Система автоматически обрабатывает входящие и исходящие звонки с номера **+79843330712**, транскрибирует их с помощью OpenAI Whisper, анализирует разговор через GPT-4o и отправляет детальный протокол в Telegram группу.

## 🔧 Как это работает

### 1. Автоматическая проверка звонков
- **Периодичность**: Каждую минуту
- **Источник**: Novofon API
- **Фильтр**: Только звонки с/на номер +79843330712
- **Направление**: Входящие И исходящие

### 2. Обработка звонка
1. ✅ Проверка что звонок не был обработан ранее
2. 📥 Скачивание аудиозаписи из Novofon
3. 🎙️ Транскрипция через OpenAI Whisper
4. 🤖 AI-анализ разговора через GPT-4o
5. 💾 Сохранение в базу данных
6. 📨 Отправка протокола в Telegram

### 3. AI-анализ для агентств недвижимости

Система анализирует разговор и определяет:

- **Название агентства/имя агента**
- **Категория лида**: ГОРЯЧИЙ / ТЁПЛЫЙ / ХОЛОДНЫЙ / ОТКАЗ
- **Рейтинг заинтересованности**: 1-10 баллов с обоснованием
- **Наличие готовых покупателей**: Да/Нет, количество
- **Бюджет клиентов**: Сумма в рублях
- **Готовность к сделке**: Временные рамки
- **Комиссия агентства**: Если упомянута
- **Ключевые интересы**: Что конкретно интересует
- **Возражения**: Что смущает или вызывает сомнения
- **Конкуренты**: Упомянутые объекты
- **Приоритет**: ВЫСОКИЙ / СРЕДНИЙ / НИЗКИЙ
- **Рекомендации**: Конкретные следующие шаги

## 📋 Протокол звонка в Telegram

```
📞 ВХОДЯЩИЙ ЗВОНОК / 📱 ИСХОДЯЩИЙ ЗВОНОК
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📅 Дата: 24.11.2025 15:30
📱 Телефон: +7 (XXX) XXX-XX-XX
⏱️ Длительность: 5м 23с
🏢 Агентство: "Мир недвижимости"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 ОЦЕНКА ЗАИНТЕРЕСОВАННОСТИ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔥 Уровень: ГОРЯЧИЙ ЛИД
⭐ Рейтинг: 8/10

📊 Обоснование:
• Активно задавал вопросы о характеристиках
• Упомянул наличие готовых покупателей
• Назначена повторная встреча

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💰 КОММЕРЧЕСКИЙ ПОТЕНЦИАЛ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ База покупателей: ДА, 3-5 готовых клиентов
💵 Бюджет клиентов: 15-20 млн руб
📅 Готовность к сделке: 1-2 месяца
📈 Комиссия агентства: 3%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 КЛЮЧЕВЫЕ МОМЕНТЫ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ Интересует планировка и метраж
✓ Важна близость к метро
⚠️ Смущает цена, просил скидку
🏆 Упомянул конкурента: "Квартал на Ленина"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ РЕКОМЕНДАЦИИ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 Приоритет: ВЫСОКИЙ

Следующие шаги:
• Отправить презентацию + планировки
• Следующий контакт через 2 дня

💡 Рекомендуемые действия:
• Подготовить коммерческое предложение
• Запланировать показ объекта

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 ТРАНСКРИПЦИЯ РАЗГОВОРА
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Полный текст разговора...]
```

## 🔌 API Endpoints

### Статус scheduler
```bash
GET /api/novofon-status/scheduler

Response:
{
  "success": true,
  "scheduler": {
    "running": true,
    "jobs": [
      {
        "id": "novofon_calls_check",
        "name": "Проверка новых звонков Novofon",
        "next_run": "2025-11-24T09:47:57+00:00",
        "trigger": "interval[0:01:00]"
      }
    ]
  }
}
```

### Статистика обработанных звонков
```bash
GET /api/novofon-status/stats

Response:
{
  "success": true,
  "stats": {
    "total_calls": 45,
    "successful": 42,
    "failed": 3
  },
  "recent_calls": [...]
}
```

### История звонков по недвижимости
```bash
GET /api/novofon-status/nedvigka-calls?limit=20

Response:
{
  "success": true,
  "total": 20,
  "calls": [
    {
      "id": "uuid",
      "call_id": "novofon_call_id",
      "caller": "+7XXXXXXXXXX",
      "called": "+79843330712",
      "direction": "in",
      "duration": 323,
      "agency_name": "Мир недвижимости",
      "lead_category": "ГОРЯЧИЙ ЛИД",
      "interest_rating": 8,
      "priority": "ВЫСОКИЙ",
      "created_at": "2025-11-24T15:30:00"
    }
  ]
}
```

### Детали конкретного звонка
```bash
GET /api/novofon-status/call-detail/{call_id}

Response:
{
  "success": true,
  "call": {
    "id": "uuid",
    "call_id": "novofon_call_id",
    "transcription": "Полная транскрипция...",
    "analysis": {
      "agency_name": "...",
      "lead_category": "...",
      "interest_rating": 8,
      ...
    }
  }
}
```

## 📊 База данных

### Таблица: `nedvigka_calls`
Хранит полную информацию о звонках:
- call_id, caller, called, direction, duration
- transcription (полный текст)
- analysis (JSON с AI-анализом)
- agency_name, lead_category, interest_rating, priority

### Таблица: `processed_calls`
Отслеживает обработанные звонки для избежания дублирования:
- call_id (уникальный)
- processed_at (время обработки)
- success (успешно/ошибка)

## ⚙️ Переменные окружения (Render)

```bash
# Novofon API
novofon_appid=appid_1938537
novofon_secret=ua04x2zlh7i2cmrqsis1b6kdwgpfgts8a8ew144tc
NOVOFON_CALLER_ID=+79843330712

# Telegram
TELEGRAM_BOT_TOKEN=...
TG_NEDVIGKA=-5007549435

# OpenAI
OPENAI_API_KEY=...
```

## 🚀 Запуск и работа

### Автоматический запуск
Система запускается автоматически при старте backend сервера:
1. При startup сервера запускается scheduler
2. Scheduler добавляет задачу проверки звонков (каждую минуту)
3. Задача начинает работать автоматически

### Логи
Проверка работы в логах:
```bash
tail -f /var/log/supervisor/backend.err.log | grep Novofon
```

Важные сообщения:
- ✅ `NovofonAutoProcessor initialized for phone: +79843330712`
- ✅ `Scheduler started successfully!`
- ✅ `Novofon auto-processor: checking every 1 minute`
- 🔍 `Checking for new calls from Novofon...`
- 📞 `Found X calls, filtering...`
- ✅ `Call {id} processed successfully!`

## 🔍 Мониторинг

### 1. Проверка статуса scheduler
```bash
curl http://localhost:8001/api/novofon-status/scheduler
```

### 2. Проверка статистики
```bash
curl http://localhost:8001/api/novofon-status/stats
```

### 3. Просмотр последних звонков
```bash
curl http://localhost:8001/api/novofon-status/nedvigka-calls?limit=10
```

## ⚠️ Важные моменты

1. **Не обрабатывает дважды**: Система автоматически проверяет таблицу `processed_calls` и пропускает уже обработанные звонки

2. **Только записанные звонки**: Обрабатываются только звонки с записью (`is_recorded=True`)

3. **Фильтрация по номеру**: Только звонки где участвует +79843330712 (входящие или исходящие)

4. **Интервал проверки**: По умолчанию 5 минут истории (можно изменить в коде)

5. **Отказоустойчивость**: Если обработка звонка упала с ошибкой, он помечается как `success=False` и можно повторить вручную

## 🛠️ Техническая информация

### Файлы проекта
- `/app/backend/app/services/novofon_auto_processor.py` - Основной процессор
- `/app/backend/app/services/novofon_service.py` - Сервис работы с Novofon API
- `/app/backend/app/services/scheduler.py` - Планировщик задач
- `/app/backend/app/routers/novofon_status.py` - API для мониторинга
- `/app/backend/server.py` - Интеграция scheduler при startup

### Зависимости
- APScheduler 3.11.0 (уже установлен)
- httpx (для HTTP запросов)
- OpenAI SDK (для Whisper и GPT-4o)
- SQLAlchemy (для работы с БД)

## 📝 Примечания

- Все транскрипции сохраняются в БД для истории
- AI-анализ происходит для КАЖДОГО звонка
- Протокол отправляется сразу после обработки
- Система работает 24/7 автоматически
- Не требует ручного вмешательства

## 🎉 Готово к работе!

Система полностью настроена и готова к работе. Каждый звонок с номера +79843330712 будет автоматически обработан и протокол придет в Telegram группу!
