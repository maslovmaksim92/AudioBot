#!/usr/bin/env python3
"""
Скрипт для импорта расходов из Excel файла в PostgreSQL
"""
import asyncpg
import asyncio
import json
from datetime import datetime
import uuid

# Данные из Excel файла
EXPENSES_DATA = [
    {"месяц": "January 2025", "категория": "Аутсорсинг", "сумма": 116160.00},
    {"месяц": "January 2025", "категория": "Зарплата", "сумма": 1316490.65},
    {"месяц": "January 2025", "категория": "Канцтовары", "сумма": 5640.00},
    {"месяц": "January 2025", "категория": "Коммунальные услуги", "сумма": 224102.93},
    {"месяц": "January 2025", "категория": "Кредиты", "сумма": 752132.44},
    {"месяц": "January 2025", "категория": "Лизинг", "сумма": 99664.02},
    {"месяц": "January 2025", "категория": "Материалы", "сумма": 228255.68},
    {"месяц": "January 2025", "категория": "Мобильная связь", "сумма": 5640.00},
    {"месяц": "January 2025", "категория": "Покупка авто", "сумма": 64367.49},
    {"месяц": "January 2025", "категория": "Продукты питания", "сумма": 1440.00},
    {"месяц": "January 2025", "категория": "Прочие расходы", "сумма": 11938.31},
    {"месяц": "January 2025", "категория": "Реклама и маркетинг", "сумма": 83616.50},
    {"месяц": "January 2025", "категория": "Транспорт", "сумма": 302669.69},
    {"месяц": "January 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 1221582.89},
    {"месяц": "January 2025", "категория": "Цифровая техника", "сумма": 800.00},
    {"месяц": "January 2025", "категория": "Юридические услуги", "сумма": 23739.00},
    {"месяц": "February 2025", "категория": "Аренда", "сумма": 89609.00},
    {"месяц": "February 2025", "категория": "Аутсорсинг", "сумма": 46000.00},
    {"месяц": "February 2025", "категория": "Зарплата", "сумма": 1978256.17},
    {"месяц": "February 2025", "категория": "Канцтовары", "сумма": 31300.00},
    {"месяц": "February 2025", "категория": "Коммунальные услуги", "сумма": 214828.20},
    {"месяц": "February 2025", "категория": "Кредиты", "сумма": 850854.14},
    {"месяц": "February 2025", "категория": "Лизинг", "сумма": 99648.00},
    {"месяц": "February 2025", "категория": "Материалы", "сумма": 340618.09},
    {"месяц": "February 2025", "категория": "Мобильная связь", "сумма": 5740.00},
    {"месяц": "February 2025", "категория": "Покупка авто", "сумма": 64217.63},
    {"месяц": "February 2025", "категория": "Продукты питания", "сумма": 1440.00},
    {"месяц": "February 2025", "категория": "Реклама и маркетинг", "сумма": 139699.00},
    {"месяц": "February 2025", "категория": "Транспорт", "сумма": 302380.16},
    {"месяц": "February 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 830728.84},
    {"месяц": "February 2025", "категория": "Цифровая техника", "сумма": 4600.00},
    {"месяц": "February 2025", "категория": "Юридические услуги", "сумма": 25240.00},
    {"месяц": "March 2025", "категория": "Аренда", "сумма": 91803.00},
    {"месяц": "March 2025", "категория": "Аутсорсинг", "сумма": 2000.00},
    {"месяц": "March 2025", "категория": "Зарплата", "сумма": 1992178.87},
    {"месяц": "March 2025", "категория": "Коммунальные услуги", "сумма": 284801.05},
    {"месяц": "March 2025", "категория": "Кредиты", "сумма": 511074.21},
    {"месяц": "March 2025", "категория": "Лизинг", "сумма": 99648.00},
    {"месяц": "March 2025", "категория": "Материалы", "сумма": 88659.65},
    {"месяц": "March 2025", "категория": "Мобильная связь", "сумма": 5340.00},
    {"месяц": "March 2025", "категория": "Покупка авто", "сумма": 71955.71},
    {"месяц": "March 2025", "категория": "Прочие расходы", "сумма": 62854.07},
    {"месяц": "March 2025", "категория": "Реклама и маркетинг", "сумма": 94448.00},
    {"месяц": "March 2025", "категория": "Транспорт", "сумма": 302889.43},
    {"месяц": "March 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 1142548.81},
    {"месяц": "March 2025", "категория": "Цифровая техника", "сумма": 4500.00},
    {"месяц": "March 2025", "категория": "Юридические услуги", "сумма": 64136.80},
    {"месяц": "April 2025", "категория": "Аренда", "сумма": 179091.00},
    {"месяц": "April 2025", "категория": "Зарплата", "сумма": 1886796.91},
    {"месяц": "April 2025", "категория": "Коммунальные услуги", "сумма": 427459.98},
    {"месяц": "April 2025", "категория": "Кредиты", "сумма": 235888.08},
    {"месяц": "April 2025", "категория": "Лизинг", "сумма": 99702.66},
    {"месяц": "April 2025", "категория": "Материалы", "сумма": 96228.19},
    {"месяц": "April 2025", "категория": "Мобильная связь", "сумма": 5340.00},
    {"месяц": "April 2025", "категория": "Покупка авто", "сумма": 79071.81},
    {"месяц": "April 2025", "категория": "Продукты питания", "сумма": 3600.00},
    {"месяц": "April 2025", "категория": "Прочие расходы", "сумма": 37732.02},
    {"месяц": "April 2025", "категория": "Реклама и маркетинг", "сумма": 371005.18},
    {"месяц": "April 2025", "категория": "Транспорт", "сумма": 239068.01},
    {"месяц": "April 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 1001695.59},
    {"месяц": "April 2025", "категория": "Юридические услуги", "сумма": 30322.24},
    {"месяц": "May 2025", "категория": "Зарплата", "сумма": 2047540.19},
    {"месяц": "May 2025", "категория": "Коммунальные услуги", "сумма": 269472.48},
    {"месяц": "May 2025", "категория": "Кредиты", "сумма": 224045.98},
    {"месяц": "May 2025", "категория": "Лизинг", "сумма": 113648.00},
    {"месяц": "May 2025", "категория": "Материалы", "сумма": 95606.99},
    {"месяц": "May 2025", "категория": "Мобильная связь", "сумма": 5240.00},
    {"месяц": "May 2025", "категория": "Покупка авто", "сумма": 83991.64},
    {"месяц": "May 2025", "категория": "Продукты питания", "сумма": 2880.00},
    {"месяц": "May 2025", "категория": "Прочие расходы", "сумма": 21204.00},
    {"месяц": "May 2025", "категория": "Реклама и маркетинг", "сумма": 60458.00},
    {"месяц": "May 2025", "категория": "Транспорт", "сумма": 214992.07},
    {"месяц": "May 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 850142.34},
    {"месяц": "June 2025", "категория": "Аренда", "сумма": 88449.00},
    {"месяц": "June 2025", "категория": "Зарплата", "сумма": 1655732.72},
    {"месяц": "June 2025", "категория": "Коммунальные услуги", "сумма": 888470.84},
    {"месяц": "June 2025", "категория": "Кредиты", "сумма": 39151.00},
    {"месяц": "June 2025", "категория": "Материалы", "сумма": 5193.92},
    {"месяц": "June 2025", "категория": "Мобильная связь", "сумма": 3840.00},
    {"месяц": "June 2025", "категория": "Покупка авто", "сумма": 23684.02},
    {"месяц": "June 2025", "категория": "Продукты питания", "сумма": 1440.00},
    {"месяц": "June 2025", "категория": "Прочие расходы", "сумма": 2472814.69},
    {"месяц": "June 2025", "категория": "Реклама и маркетинг", "сумма": 2000.00},
    {"месяц": "June 2025", "категория": "Транспорт", "сумма": 114409.90},
    {"месяц": "June 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 467799.13},
    {"месяц": "June 2025", "категория": "Юридические услуги", "сумма": 30000.00},
    {"месяц": "July 2025", "категория": "Аренда", "сумма": 50000.00},
    {"месяц": "July 2025", "категория": "Зарплата", "сумма": 2124028.17},
    {"месяц": "July 2025", "категория": "Коммунальные услуги", "сумма": 288116.12},
    {"месяц": "July 2025", "категория": "Кредиты", "сумма": 405922.24},
    {"месяц": "July 2025", "категория": "Лизинг", "сумма": 204296.00},
    {"месяц": "July 2025", "категория": "Материалы", "сумма": 91768.76},
    {"месяц": "July 2025", "категория": "Мобильная связь", "сумма": 8140.00},
    {"месяц": "July 2025", "категория": "Покупка авто", "сумма": 109850.67},
    {"месяц": "July 2025", "категория": "Продукты питания", "сумма": 2160.00},
    {"месяц": "July 2025", "категория": "Прочие расходы", "сумма": 1008815.96},
    {"месяц": "July 2025", "категория": "Реклама и маркетинг", "сумма": 123803.00},
    {"месяц": "July 2025", "категория": "Транспорт", "сумма": 221241.23},
    {"месяц": "July 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 314449.16},
    {"месяц": "July 2025", "категория": "Цифровая техника", "сумма": 5100.00},
    {"месяц": "July 2025", "категория": "Юридические услуги", "сумма": 135000.00},
    {"месяц": "August 2025", "категория": "Аренда", "сумма": 119785.00},
    {"месяц": "August 2025", "категория": "Зарплата", "сумма": 2426392.64},
    {"месяц": "August 2025", "категория": "Коммунальные услуги", "сумма": 313694.40},
    {"месяц": "August 2025", "категория": "Кредиты", "сумма": 220956.15},
    {"месяц": "August 2025", "категория": "Лизинг", "сумма": 102053.23},
    {"месяц": "August 2025", "категория": "Материалы", "сумма": 63608.40},
    {"месяц": "August 2025", "категория": "Мобильная связь", "сумма": 5640.00},
    {"месяц": "August 2025", "категория": "Покупка авто", "сумма": 77657.82},
    {"месяц": "August 2025", "категория": "Продукты питания", "сумма": 1440.00},
    {"месяц": "August 2025", "категория": "Прочие расходы", "сумма": 1001672.22},
    {"месяц": "August 2025", "категория": "Реклама и маркетинг", "сумма": 22353.00},
    {"месяц": "August 2025", "категория": "Транспорт", "сумма": 173857.73},
    {"месяц": "August 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 1400.00},
    {"месяц": "August 2025", "категория": "Юридические услуги", "сумма": 115000.00},
    {"месяц": "September 2025", "категория": "Аренда", "сумма": 85704.00},
    {"месяц": "September 2025", "категория": "Зарплата", "сумма": 2217875.44},
    {"месяц": "September 2025", "категория": "Коммунальные услуги", "сумма": 739689.96},
    {"месяц": "September 2025", "категория": "Кредиты", "сумма": 219666.70},
    {"месяц": "September 2025", "категория": "Материалы", "сумма": 46024.50},
    {"месяц": "September 2025", "категория": "Мобильная связь", "сумма": 5880.00},
    {"месяц": "September 2025", "категория": "Покупка авто", "сумма": 98693.21},
    {"месяц": "September 2025", "категория": "Продукты питания", "сумма": 1440.00},
    {"месяц": "September 2025", "категория": "Прочие расходы", "сумма": 863380.18},
    {"месяц": "September 2025", "категория": "Реклама и маркетинг", "сумма": 142080.58},
    {"месяц": "September 2025", "категория": "Транспорт", "сумма": 185998.25},
    {"месяц": "September 2025", "категория": "Филиал Ленинск-Кузнецкий", "сумма": 174397.95},
    {"месяц": "September 2025", "категория": "Цифровая техника", "сумма": 11400.00},
]

MONTH_MAP = {
    'January': 1,
    'February': 2,
    'March': 3,
    'April': 4,
    'May': 5,
    'June': 6,
    'July': 7,
    'August': 8,
    'September': 9,
}

async def import_expenses():
    """Импорт расходов в базу данных"""
    conn = await asyncpg.connect(
        'postgresql://vasdom_user:Vasdom40!@rc1a-gls4njl0umfqv554.mdb.yandexcloud.net:6432/vasdom_audiobot?sslmode=require'
    )
    
    try:
        # 1. Удаляем все расходы за 2025 год
        deleted = await conn.execute(
            "DELETE FROM financial_transactions WHERE type = 'expense' AND EXTRACT(YEAR FROM date) = 2025"
        )
        print(f"✅ Удалено старых записей: {deleted}")
        
        # 2. Вставляем новые данные
        inserted = 0
        for item in EXPENSES_DATA:
            # Парсим месяц
            month_name, year = item['месяц'].split()
            month_num = MONTH_MAP[month_name]
            
            # Создаем дату (1-е число месяца)
            date = f"{year}-{month_num:02d}-01"
            
            # Вставляем запись
            await conn.execute("""
                INSERT INTO financial_transactions 
                (id, date, amount, category, type, description, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5, $6, NOW(), NOW())
            """, 
                str(uuid.uuid4()),
                date,
                item['сумма'],
                item['категория'],
                'expense',
                f"Импорт из Excel - {item['категория']}"
            )
            inserted += 1
        
        print(f"✅ Вставлено новых записей: {inserted}")
        
        # 3. Проверяем итоги
        result = await conn.fetchrow("""
            SELECT 
                COUNT(*) as count,
                SUM(amount) as total
            FROM financial_transactions 
            WHERE type = 'expense' AND EXTRACT(YEAR FROM date) = 2025
        """)
        
        print(f"\nИтого в базе:")
        print(f"  Записей: {result['count']}")
        print(f"  Общая сумма: {result['total']:.2f} ₽")
        
        # Итоги по месяцам
        monthly = await conn.fetch("""
            SELECT 
                TO_CHAR(date, 'Month YYYY') as month,
                SUM(amount) as total
            FROM financial_transactions 
            WHERE type = 'expense' AND EXTRACT(YEAR FROM date) = 2025
            GROUP BY TO_CHAR(date, 'YYYY-MM'), TO_CHAR(date, 'Month YYYY')
            ORDER BY TO_CHAR(date, 'YYYY-MM')
        """)
        
        print(f"\nРасходы по месяцам:")
        for row in monthly:
            print(f"  {row['month'].strip()}: {row['total']:.2f} ₽")
        
    finally:
        await conn.close()

if __name__ == '__main__':
    asyncio.run(import_expenses())
