"""
Отправка тестовой карточки звонка в Telegram
"""
import asyncio
import httpx
import os
from dotenv import load_dotenv

# Загружаем переменные окружения
load_dotenv('/app/backend/.env')

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TG_NEDVIGKA = os.getenv("TG_NEDVIGKA", "-5007549435")

async def send_test_card():
    """Отправляет тестовую карточку звонка"""
    
    # Тестовые данные
    test_message = """📱 <b>Исходящий звонок</b>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📅 <b>Дата:</b> 24.11.2025 15:30
📱 <b>Телефон:</b> <code>+7 (912) 345-67-89</code>
⏱️ <b>Длительность:</b> 5м 23с
🏢 <b>Агентство:</b> "Мир недвижимости"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 <b>ОЦЕНКА ЗАИНТЕРЕСОВАННОСТИ</b>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔥 <b>Уровень:</b> ГОРЯЧИЙ ЛИД
⭐ <b>Рейтинг:</b> 8/10

📊 <b>Обоснование:</b>
• Активно задавал вопросы о характеристиках объекта
• Упомянул наличие 3-5 готовых покупателей
• Назначена повторная встреча на этой неделе
• Готов выехать на просмотр в ближайшие дни

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💰 <b>КОММЕРЧЕСКИЙ ПОТЕНЦИАЛ</b>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ <b>База покупателей:</b> ДА, 3-5 готовых клиентов
💵 <b>Бюджет клиентов:</b> 15-20 млн руб
📅 <b>Готовность к сделке:</b> 1-2 месяца
📈 <b>Комиссия агентства:</b> 3%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 <b>КЛЮЧЕВЫЕ МОМЕНТЫ</b>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ Интересует планировка 3-комнатных квартир
✓ Важна близость к метро (не более 10 минут пешком)
✓ Клиенты готовы рассмотреть варианты без отделки
⚠️ Смущает цена, просил возможность скидки
🏆 Упомянул конкурента: "Квартал на Ленина"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ <b>РЕКОМЕНДАЦИИ</b>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 <b>Приоритет:</b> ВЫСОКИЙ

<b>Следующие шаги:</b>
• Отправить презентацию объекта + планировки всех доступных квартир
• Подготовить варианты рассрочки или ипотеки
• Следующий контакт через 2 дня для подтверждения встречи

<b>💡 Рекомендуемые действия:</b>
• Подготовить коммерческое предложение с учетом бюджета
• Запланировать показ объекта на эту неделю
• Подготовить сравнение с "Кварталом на Ленина"
• Рассчитать возможность скидки при быстрой сделке

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 <b>ТРАНСКРИПЦИЯ РАЗГОВОРА</b>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Менеджер: Добрый день! Агентство "Мир недвижимости", меня зовут Алексей.

Клиент: Здравствуйте, вы нам отправляли информацию по объекту на улице Победы?

Менеджер: Да, верно! Я высылал вам презентацию нашего жилого комплекса. У вас есть вопросы?

Клиент: Да, у нас есть несколько клиентов которые ищут трёшки в этом районе. Бюджет 15-20 миллионов. Можете рассказать подробнее?

Менеджер: Отлично! У нас сейчас доступны квартиры от 85 до 120 квадратных метров. Все с хорошими планировками, большими кухнями...

Клиент: А до метро как далеко? Это важно для наших клиентов.

Менеджер: Буквально 7 минут пешком до станции "Площадь Победы". Это очень удобно.

Клиент: Хорошо. А по цене есть какая-то гибкость? Просто у ваших конкурентов в "Квартале на Ленина" цены немного ниже...

Менеджер: Понимаю. Давайте встретимся, покажу объект, и мы сможем обсудить индивидуальные условия для ваших клиентов.

Клиент: Договорились. Я позвоню вам в четверг, согласуем время.

<i>🤖 Это тестовая карточка для проверки работы системы автоматической транскрипции звонков Novofon</i>"""
    
    try:
        print(f"📤 Отправка тестовой карточки в Telegram группу {TG_NEDVIGKA}...")
        
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.post(
                f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage",
                json={
                    "chat_id": TG_NEDVIGKA,
                    "text": test_message,
                    "parse_mode": "HTML"
                }
            )
            
            if response.status_code == 200:
                result = response.json()
                if result.get("ok"):
                    print(f"✅ Тестовая карточка успешно отправлена!")
                    print(f"📨 Message ID: {result['result']['message_id']}")
                    print(f"📱 Chat ID: {result['result']['chat']['id']}")
                    print(f"\n🎉 Проверьте Telegram группу!")
                else:
                    print(f"❌ Ошибка Telegram API: {result}")
            else:
                print(f"❌ HTTP Error: {response.status_code}")
                print(f"Response: {response.text}")
                
    except Exception as e:
        print(f"❌ Ошибка отправки: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    print("="*60)
    print("🧪 ТЕСТОВАЯ ОТПРАВКА КАРТОЧКИ ЗВОНКА В TELEGRAM")
    print("="*60)
    print(f"Bot Token: {TELEGRAM_BOT_TOKEN[:20]}..." if TELEGRAM_BOT_TOKEN else "⚠️ Bot Token не найден")
    print(f"Chat ID: {TG_NEDVIGKA}")
    print("="*60)
    print()
    
    asyncio.run(send_test_card())
